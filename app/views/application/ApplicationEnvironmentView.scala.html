@*
 * Copyright 2024 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import config.{HipEnvironment, HipEnvironments}
@import models.application._
@import models.application.ApplicationLenses._
@import models.user.UserModel
@import viewmodels.application.{ApplicationNavItems, ApplicationSideNavPages}
@import views.html.components.IconsLink
@import views.ViewUtils

@this(
    layout: templates.Layout,
    iconsLink: IconsLink,
    govukTabs: GovukTabs,
    govukButton : GovukButton,
    formHelper: FormWithCSRF,
    hipEnvironments: HipEnvironments
)

@(application: Application, hipEnvironment: HipEnvironment, user: UserModel)(implicit request: Request[?], messages: Messages)

@canDeleteCredentials() = @{
    application.getCredentialsFor(hipEnvironment.environmentName).size > 1 &&
        (user.permissions.canSupport ||
            (application.hasTeamMember(user) && (hipEnvironment.environmentName == Secondary || user.permissions.isPrivileged)))
}

@apisTabContent() = {

    <div class="environment-block-header">
        <div class="left">
            <h2 class="govuk-heading-m">APIs</h2>
        </div>
    </div>

    @if(application.apis.isEmpty) {
        <div class="call-out-panel">
            <p class="govuk-body information-tag ">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <span class="call-out-type">
                    @messages("environmentAndCredentials.test.noApis")
                </span>
            </p>
            <p class="govuk-body additional-message">
                @messages("environmentAndCredentials.test.noApis.additional")
            </p>
        </div>
    } else {
        <ul class="govuk-list govuk-list--bullet">
        @for(api <- application.apis) {
            <li>@api.title</li>
        }
        </ul>
    }

}

@credentialsTabContent() = {

    <div class="environment-block-header">
        <div class="left">
            <h2 class="govuk-heading-m">Credentials</h2>
        </div>

        @if(!hipEnvironment.isProductionLike || user.permissions.isPrivileged) {
            <div class="right govuk-!-text-align-right">
                @formHelper(action = controllers.application.routes.AddCredentialController.addDevelopmentCredential(application.id), Symbol("autoComplete") -> "off") {
                    @govukButton(
                        Button(
                            classes = "govuk-button--secondary",
                            content = Text(messages("environmentAndCredentials.addNewCredential"))
                        ).disabled(application.getSecondaryCredentials.size >= 5).withId("addNewCredential")
                    )
                }
            </div>
        }
    </div>

    @if(application.apis.isEmpty) {
        <div class="call-out-panel">
            <p class="govuk-body information-tag ">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <span class="call-out-type">
                    @messages("environmentAndCredentials.test.noApis")
                </span>
            </p>
            <p class="govuk-body additional-message">
                @messages("environmentAndCredentials.test.noApis.additional")
            </p>
        </div>
    }

    @if(hipEnvironment.isProductionLike && application.getCredentialsFor(hipEnvironment.environmentName).isEmpty) {
        <p class="govuk-body">
            @messages("environmentAndCredentials.noCredentials")
        </p>
    } else {
        @for(credential <- application.getCredentialsFor(hipEnvironment.environmentName)) {
            <div class="api-panel api-panel--small">
                <p data-test-credential-client-id="@credential.clientId" class="govuk-body govuk-!-margin-bottom-3">
                    <strong>@messages("environmentAndCredentials.clientId"):</strong>
                    @credential.clientId
                </p>
                <p class="govuk-body govuk-!-margin-bottom-3">
                    <strong>@messages("environmentAndCredentials.clientSecret"):</strong>
                    @credential.clientSecret.getOrElse("")
                </p>
                <p class="govuk-body govuk-!-margin-bottom-3">
                    <strong>@messages("environmentAndCredentials.created"):</strong>
                    <span class="utcDateTime">@ViewUtils.formatLocalDateTimeContainingUtc(credential.created)</span>
                </p>
                @if(canDeleteCredentials()) {
                    <div class="govuk-button-group govuk-!-margin-bottom-3">
                        <a data-test-credential-client-id="@credential.clientId" class="govuk-link govuk-!-margin-bottom-0" href="@controllers.application.routes.EnvironmentAndCredentialsController.deleteSecondaryCredential(application.id, credential.clientId).url">
                            @messages("environmentAndCredentials.deleteCredential")
                        </a>
                    </div>
                }
            </div>
        }
    }

}

@layout(pageTitle = titleNoForm(messages("applicationEnvironment.title", messages(hipEnvironment.nameKey))), user = Some(user), fullWidth = true, customScriptsBlock = Some(iconsLink())) {

    @views.html.templates.SideNav(application.name, ApplicationNavItems(Some(user), application, ApplicationSideNavPages.EnvironmentPage(hipEnvironment), hipEnvironments)) {

        <h1 class="govuk-heading-l">@messages("applicationEnvironment.heading", messages(hipEnvironment.nameKey))</h1>

        @govukTabs(
            Tabs(
                items = Seq(
                    TabItem(
                        id = Some("apisTab"),
                        label = "APIs",
                        panel = TabPanel(content = HtmlContent(apisTabContent()))
                    ),
                    TabItem(
                        id = Some("credentialsTab"),
                        label = "Credentials",
                        panel = TabPanel(content = HtmlContent(credentialsTabContent()))
                    )
                )
            )
        )
    }

}
