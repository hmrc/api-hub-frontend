@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import models.AvailableEndpoint
@import models.api.ApiDetail
@import models.user.UserModel

@this(
    layout: templates.Layout,
    formHelper: FormWithCSRF,
    govukErrorSummary: GovukErrorSummary,
    govukCheckboxes: GovukCheckboxes,
    govukButton: GovukButton
)

@(form: Form[_], mode: Mode, user: Option[UserModel], apiDetail: ApiDetail)(implicit request: Request[_], messages: Messages)

@scripts() = {
    <style>
        .scopes-list {
            font-size: 16px;
        }
        .custom-normal-case {
            text-transform: none !important;
        }
        .notgovuk-checkboxes__item {
            margin-top: 30px;
            padding: 30px 30px 10px 30px;
            background-color: #f3f2f1;
        }
    </style>
}

@checkboxItems(apiDetail: ApiDetail) = @{
    val availableEndpoints = AvailableEndpoints(apiDetail)

    availableEndpoints
        .toSeq
        .zipWithIndex
        .map {
            case (value, index) =>
                CheckboxItemViewModel(
                    content =
                        if (value._2.size == 1) {
                            Text(messages("addAnApiSelectEndpoints.selectEndpoint"))
                        }
                        else {
                            Text(messages("addAnApiSelectEndpoints.selectEndpoints"))
                        },
                    fieldId = "value",
                    index   = index,
                    value   = value._1.toString
                ).withHint(Hint(content = HtmlContent(checkBoxItemContentHtml(value._1, value._2))))
        }

}

@checkBoxItemContentHtml(scopes: Set[String], availableEndpoints: Seq[AvailableEndpoint]) = {
    @for(availableEndpoint <- availableEndpoints) {
        <p class="govuk-body govuk-!-margin-bottom-2 ">
            <strong class="govuk-tag govuk-tag--blue ">
                @availableEndpoint.endpointMethod.httpMethod
            </strong>
            <strong>
                @availableEndpoint.path
            </strong>
        </p>
        <p class="govuk-body-s">
            @availableEndpoint.endpointMethod.summary.getOrElse("")
        </p>
    }

    <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

    <div>
        <p class="govuk-body govuk-!-font-size-16 govuk-!-margin-top-3 govuk-!-margin-bottom-1">
            @messages("addAnApiSelectEndpoints.scopesUsed")
        </p>
        <ul class="govuk-list govuk-list-inline scopes-list">
            @for(scope <- scopes) {
                <li>
                    <strong class="govuk-tag govuk-tag--grey custom-normal-case">
                        @scope
                    </strong>
                </li>
            }
        </ul>
    </div>
}

@layout(pageTitle = title(form, messages("addAnApiSelectEndpoints.title")), user = user, customScriptsBlock = Some(scripts())) {

    @formHelper(action = routes.AddAnApiSelectEndpointsController.onSubmit(mode), Symbol("autoComplete") -> "off") {

        @if(form.errors.nonEmpty) {
            @govukErrorSummary(ErrorSummaryViewModel(form, errorLinkOverrides = Map("value" -> "value_0")))
        }

        @govukCheckboxes(
            CheckboxesViewModel(
                form   = form,
                name   = "value",
                legend = LegendViewModel(messages("addAnApiSelectEndpoints.heading"))
                    .withCssClass("govuk-fieldset__legend--l")
                    .asPageHeading(),
                items  = checkboxItems(apiDetail)
            )
        )

        @govukButton(
            ButtonViewModel(messages("site.continue"))
        )
    }
}
